# Base docker-compose for all retrace tests
#
# Run with: TEST_DIR=./tests/postgress_test docker compose up --exit-code-from cleanup
# Or:       TEST_DIR=./tests/simple_test docker compose up --exit-code-from cleanup

services:
  install:
    image: ${TEST_IMAGE:-python:3.11-slim}
    volumes:
      - ./install.sh:/app/install.sh:ro
      - ./base-requirements.txt:/app/dockertests/base-requirements.txt:ro
      - ${TEST_DIR:-.}:/app/test:ro
      - ./.cache/pip:/root/.cache/pip
      - ${TEST_PACKAGES_DIR:-./.cache/packages}:/app/packages
    command: bash /app/install.sh

  dryrun:
    image: ${TEST_IMAGE:-python:3.11-slim}
    depends_on:
      install:
        condition: service_completed_successfully
    volumes:
      - ${TEST_DIR:-.}:/app/test:ro
      - ${TEST_PACKAGES_DIR:-./.cache/packages}:/app/packages:ro
    environment:
      PYTHONPATH: /app/packages
    command: python /app/test/test.py

  record:
    image: ${TEST_IMAGE:-python:3.11-slim}
    depends_on:
      dryrun:
        condition: service_completed_successfully
    volumes:
      - ${TEST_DIR:-.}:/app/test:ro
      - ${TEST_DIR:-.}/recording:/recording:rw
      - ${TEST_PACKAGES_DIR:-./.cache/packages}:/app/packages:ro
    environment:
      PYTHONPATH: /app/packages
      RETRACE: "1"
      RETRACE_RECORDING_PATH: /recording
    command: bash -c "python -m retracesoftware install && python /app/test/test.py"

  replay:
    image: ${TEST_IMAGE:-python:3.11-slim}
    depends_on:
      record:
        condition: service_completed_successfully
    network_mode: none
    volumes:
      - ${TEST_DIR:-.}:/app/test:ro
      - ${TEST_DIR:-.}/recording:/recording:ro
      - ${TEST_PACKAGES_DIR:-./.cache/packages}:/app/packages:ro
    environment:
      PYTHONPATH: /app/packages
    command: python -m retracesoftware --recording /recording

  cleanup:
    image: alpine
    depends_on:
      replay:
        condition: service_completed_successfully
    volumes:
      - ${TEST_DIR:-.}/recording:/recording:rw
    command: sh -c "rm -rf /recording/*"

# No named volumes - using local .cache/ directory for packages
